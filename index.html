<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>ä¸€æ¬¡é–¢æ•°ãƒˆãƒ©ãƒ³ãƒ— v40ï¼ˆæ”¹è‰¯ç‰ˆï¼‰</title>
<!-- PWAå¯¾å¿œ -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#001428">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<style>
  :root{ --bg1:#001428; --bg2:#00263e; --panel:#021a2d; --accent:#ffd966; }
  html,body{height:100%; margin:0; font-family:"Segoe UI",sans-serif; background:linear-gradient(var(--bg1),var(--bg2)); color:#fff;}
  h1{font-size:40px; font-weight:800; text-align:center; margin:28px 0;}
  .container-box{background:var(--panel); padding:20px 26px; border-radius:14px; max-width: 90%; width: auto; box-shadow:0 0 8px #0007; margin:0 auto;}
  button{padding:8px 10px;border-radius:6px;border:none;cursor:pointer;background:#fff;color:#000;}
  input[type=number]{padding:6px;border-radius:6px;border:none;width:80px;}
  #gameArea{display:flex;gap:32px;padding:24px;}
  #cardArea{flex:1; min-height:420px;}
  .card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:12px;margin-top:18px;}
  .card{perspective:800px; cursor:pointer; position:relative;}
  .card-inner{transition: transform .45s; transform-style: preserve-3d; position:relative; width:100%; min-height:90px; border-radius:10px;}
  .face{backface-visibility:hidden; position:absolute; left:0; top:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; padding:8px; border-radius:10px;}
  .front{background:#072033; font-size:22px;}
  .back{background:#0c2a3d; transform:rotateY(180deg); overflow:auto; color:#fff; font-size:14px;}
  .card.flipped .card-inner{transform:rotateY(180deg);}
  .card.matched{opacity:0.45; pointer-events:none;}
  .table-card table{border-collapse:collapse; width:100%; table-layout: fixed;}
  .table-card td,.table-card th{padding:4px; border:1px solid rgba(255,255,255,0.06); font-size:13px; text-align:center;}
  .baba-container{display:flex;flex-direction:column;align-items:center;gap:14px}
  .circle-wrap{position:relative;width:560px;height:420px;}
  .player-slot{position:absolute; width:120px; text-align:center; transform-origin:center center;}
  .player-slot .slot-panel{background:rgba(2,40,50,0.85); padding:8px;border-radius:10px;}
  .player-slot.current .slot-panel{box-shadow:0 0 18px var(--accent); border:2px solid rgba(255,217,102,0.2);}
  .player-slot .draw-btn{margin-top:8px;padding:6px;border-radius:6px;background:#fff;color:#000;cursor:pointer;}
  .hand-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;padding-top:8px;}
  .hand-card{background:#06313f;padding:8px;border-radius:8px;min-width:80px;min-height:50px;display:flex;align-items:center;justify-content:center;text-align:center;cursor:default;}
  .hand-card.selectable{cursor:pointer; outline:none;}
  .hand-card.selected{outline:3px solid #ffd966;}
  .modal-back{display:none; position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:100; align-items:center; justify-content:space-around;}
  .modal{background:#fff;color:#000;border-radius:10px;padding:14px; max-height:90vh; overflow:auto;}
  #graphModal .modal{width:80vw; max-width:1100px; height:80vh;}
  #matchModal .modal{width:640px;}
  #resultModal .modal{width:720px;}
  .tab-buttons{display:flex;gap:6px;margin-bottom:8px;}
  .tab-buttons button{background:#eee;color:#000;padding:6px 8px;border-radius:6px;border:none;cursor:pointer;}
  .tab-content{background:#fff;padding:8px;border-radius:6px;min-height:160px;}
  #turnBanner{font-size:22px;font-weight:800;margin-bottom:16px;display:flex;align-items:center;gap:8px;}
  .turn-badge{background:var(--panel); padding:6px 10px;border-radius:10px;}
  #learnedList{padding-left:6px;font-size:15px;max-height:360px;overflow:auto;}
  .small{font-size:13px;opacity:0.9;}
  .float-right{text-align:right;}
  @media screen and (max-width: 768px) {
    h1{ font-size: 28px; margin: 18px 0; }
    .container-box{ max-width: 95%; padding: 16px; }
    #gameArea{flex-direction: column; gap: 16px; padding: 8px;}
    #gameArea > div:nth-child(2) { width: 100% !important; }
    .circle-wrap{ width: 100%; height: 360px; }
    .player-slot{ width: 100px; }
    .baba-container{ display: block; }
    .hand-card{ min-width: 60px; min-height: 40px; font-size: 12px; padding: 4px; }
    #graphModal .modal{ width: 95vw; max-width: 95vw; height: 90vh; margin: 10px;}
    #matchModal .modal{ width: 90vw;}
    #resultModal .modal{ width: 90vw;}
  }
  @media (orientation:landscape) and (max-width:1024px) {
    h1 { font-size: 24px; }
    .container-box { max-width: 98%; padding: 8px; }
    #gameArea { flex-direction: row; gap: 8px; padding: 6px; }
    .circle-wrap { height: 210px; }
  }
  @media (orientation:portrait) and (max-width:1024px) {
    h1 { font-size: 28px; }
    .container-box { max-width: 97%; padding: 12px; }
    #gameArea { flex-direction: column; gap: 10px; padding: 4px; }
    .circle-wrap { height: 360px; }
  }
  @media screen and (max-width: 375px) {
    body, html { font-size: 12px; }
    h1 { font-size: 18px; }
    .container-box { max-width: 100vw; padding: 6px; border-radius: 0; }
    #gameArea { gap: 2px; padding: 2px; }
    .circle-wrap { width: 98vw; height: 140px; }
    .player-slot { width: 60px; }
    .hand-card { min-width: 28px; min-height: 18px; font-size: 10px; padding: 2px; }
    #learnedList { font-size: 11px; }
    .modal { font-size:12px; padding:6px; }
    #graphModal .modal, #matchModal .modal, #resultModal .modal { width: 98vw !important; max-width:98vw !important; }
  }
  .install-pwa-btn{
    position: fixed;
    bottom: 10px; right: 10px;
    z-index: 9999;
    background: var(--accent,#ffd966);
    color:#222;font-weight:700;
    border: none; border-radius:8px;
    padding: 12px 16px;font-size:18px;
    box-shadow:0 2px 8px #3335;
    cursor:pointer;display:none;
  }
</style>
</head>
<body>
<h1>ä¸€æ¬¡é–¢æ•°ãƒˆãƒ©ãƒ³ãƒ— v40ï¼ˆæ”¹è‰¯ç‰ˆï¼‰</h1>
<div id="homeScreen" style="display:flex;flex-direction:column;align-items:center;margin-top:10px;">
  <div class="container-box">
    <div style="font-size:20px;font-weight:700;margin-bottom:6px;">ãƒ¢ãƒ¼ãƒ‰ãƒ»ãƒšã‚¢æ•°ãƒ»CPUå¼·ã•ã‚’é¸ã‚“ã§ â–¶ ã‚²ãƒ¼ãƒ é–‹å§‹</div>
    <div style="margin-top:12px;">
      <div style="font-size:18px;font-weight:700;">ãƒ¢ãƒ¼ãƒ‰</div>
      <button id="modeMemoryBtn" onclick="selectMode('memory')" style="margin-right:8px;">ğŸ§  ç¥çµŒè¡°å¼±</button>
      <button id="modeBabaBtn" onclick="selectMode('babanuki')">ğŸƒ ãƒãƒæŠœã</button>
    </div>
    <div style="margin-top:16px;">
      <div style="font-size:18px;font-weight:700;">ãƒšã‚¢æ•°ï¼ˆ3ã€œ10ï¼‰</div>
      <input id="pairInput" type="number" min="3" max="10" value="4" />
    </div>
    <div style="margin-top:16px;">
      <div style="font-size:18px;font-weight:700;">CPU ã®å¼·ã•</div>
      <!-- å…ƒã®3æ®µãƒœã‚¿ãƒ³ã‚’5æ®µã«æ‹¡å¼µã€‚ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’ä»˜ä¸ã€‚è¦‹ãŸç›®ã¯ã»ã¼åŒã˜ä½ç½®ã§åã¾ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸ -->
      <div style="margin-top:8px;">
        <button data-level="1" onclick="setCPULevel(1)" title="ã»ã¼è¨˜æ†¶ã—ãªã„ï¼ã¨ã¦ã‚‚é…ã„">1<br><span style="font-size:10px">æœ€å¼±</span></button>
        <button data-level="2" onclick="setCPULevel(2)" title="å°‘ã—ã ã‘è¨˜æ†¶ï¼é…ã„" style="margin-left:6px;">2<br><span style="font-size:10px">å¼±</span></button>
        <button data-level="3" onclick="setCPULevel(3)" title="ãƒãƒ©ãƒ³ã‚¹å‹" style="margin-left:6px;">3<br><span style="font-size:10px">æ™®é€š</span></button>
        <button data-level="4" onclick="setCPULevel(4)" title="é«˜é€Ÿï¼æ·±ã„è¨˜æ†¶" style="margin-left:6px;">4<br><span style="font-size:10px">å¼·</span></button>
        <button data-level="5" onclick="setCPULevel(5)" title="å®Œå…¨è¨˜æ†¶ï¼ã¨ã¦ã‚‚é«˜é€Ÿ" style="margin-left:6px;">5<br><span style="font-size:10px">æœ€å¼·</span></button>
      </div>
    </div>
    <div style="margin-top:22px;">
      <button onclick="startGameFromHome()">â–¶ ã‚²ãƒ¼ãƒ é–‹å§‹</button>
      <button onclick="openSetup()" style="margin-left:8px;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š</button>
    </div>
  </div>
  <div class="small" style="margin-top:8px;opacity:0.9;">â€» ãƒšã‚¢æ•°ã¯æ‰‹å‹•å…¥åŠ›ã§ãã¾ã™ï¼ˆ3ã€œ10ï¼‰ã€‚è¤‡æ•°äººãƒ—ãƒ¬ã‚¤ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®šã§ã€‚</div>
</div>
<div id="gameContainer" style="display:none;padding:18px;">
  <div id="turnBanner">
    <span>ğŸ¯ ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³ï¼š</span>
    <span id="turnBadge" class="turn-badge">â€”</span>
    <div style="flex:1"></div>
    <div class="small">å­¦ç¿’å±¥æ­´</div>
  </div>
  <div id="gameArea">
    <div id="cardArea"></div>
    <div style="width:280px;">
      <div style="font-size:20px;font-weight:700;margin-bottom:10px;">å­¦ç¿’å±¥æ­´</div>
      <div id="learnedList"></div>
      <div class="small float-right" style="margin-top:12px;">
        <button onclick="openResult()">ãƒªã‚¶ãƒ«ãƒˆè¡¨ç¤º</button>
        <button onclick="goHome()" style="margin-left:6px;">ãƒ›ãƒ¼ãƒ ã¸</button>
      </div>
    </div>
  </div>
</div>
<div id="setupModal" class="modal-back">
  <div class="modal">
    <h2>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š</h2>
    <div>
      <label>äººæ•°ï¼š</label>
      <input id="setupCount" type="number" min="1" max="6" value="2" />
      <button onclick="renderSetupPlayers(Number(setupCount.value))">æ›´æ–°</button>
    </div>
    <div id="setupPlayersList" style="margin-top:10px;"></div>
    <div style="margin-top:14px;text-align:right;">
      <button onclick="applySetup()">OK</button>
      <button onclick="closeSetup()" style="margin-left:6px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>
<div id="graphModal" class="modal-back">
  <div class="modal" role="dialog" aria-modal="true">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div style="font-weight:800;" id="graphTitle">ã‚°ãƒ©ãƒ•</div>
      <div>
        <button onclick="zoomGraph(1.2)">ï¼‹</button>
        <button onclick="zoomGraph(1/1.2)">ï¼</button>
        <button onclick="closeGraph()" style="margin-left:8px;">é–‰ã˜ã‚‹</button>
      </div>
    </div>
    <canvas id="graphCanvas" width="1200" height="640" style="width:100%; height:80vh; background:#fff; margin-top:10px;"></canvas>
  </div>
</div>
<div id="matchModal" class="modal-back">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:800;" id="matchTitle">ãƒšã‚¢æˆç«‹</div>
      <div><button onclick="closeMatchModal()">é–‰ã˜ã‚‹</button></div>
    </div>
    <div class="tab-buttons" style="margin-top:10px;">
      <button onclick="showMatchTab('formula')">å¼</button>
      <button onclick="showMatchTab('table')">å¯¾å¿œè¡¨</button>
      <button onclick="showMatchTab('graph')">ã‚°ãƒ©ãƒ•</button>
    </div>
    <div id="matchContent" class="tab-content"></div>
  </div>
</div>
<div id="resultModal" class="modal-back">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:800;">ãƒªã‚¶ãƒ«ãƒˆ</div>
      <div><button onclick="closeResult()" style="margin-left:8px;">é–‰ã˜ã‚‹</button></div>
    </div>
    <div style="margin-top:10px;">
      <div id="resultScores" style="margin-bottom:10px;"></div>
      <div style="font-weight:700;">ãƒ—ãƒ¬ã‚¤ã§ä½¿ã‚ã‚ŒãŸä¸€æ¬¡é–¢æ•°ä¸€è¦§</div>
      <div id="usedFunctionsList" style="margin-top:8px;max-height:360px;overflow:auto;"></div>
    </div>
  </div>
</div>
<div id="infoCard" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:90;"></div>

<div id="cpuCardModal" class="modal-back" style="display:none;">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:800;">CPU ãŒã‚ãã£ãŸã‚«ãƒ¼ãƒ‰</div>
      <div><button onclick="closeCpuCardModal()">é–‰ã˜ã‚‹</button></div>
    </div>
    <div id="cpuCardContent" style="margin-top:10px;font-size:22px;font-weight:700;"></div>
  </div>
</div>

<!-- PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
<button id="installPwaBtn" class="install-pwa-btn">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </button>
<!-- =============== ã“ã“ã‹ã‚‰JSæœ¬ä½“ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ãƒ¯ãƒ³ =============== -->
<script>
let deferredPrompt;
const installBtn = document.getElementById('installPwaBtn');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'block';
});
if(installBtn) installBtn.addEventListener('click', async () => {
  if(deferredPrompt){
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    installBtn.style.display = 'none';
  }
});
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./service-worker.js')
  .then(()=>console.log('SW registered'))
  .catch(()=>console.log('SW registration failed'));
}

// ====== ã‚²ãƒ¼ãƒ æœ¬ä½“ã®ã‚³ãƒ¼ãƒ‰é–‹å§‹ =======
let mode = null;
let players = 2;
let playerConfig = [];
let deckCards = [];
let firstFlip = null;
let scores = [];
let turnIndex = 0;
let remainingPairs = 0;
let cpuMemory = {};
let selectedPairs = 4;
// è¿½åŠ : CPU ãƒ¬ãƒ™ãƒ«ï¼ˆ1..5ï¼‰ã€‚æ—¢å­˜ã®æ–‡å­—åˆ—è¨­å®šã¨ã‚‚äº’æ›ã‚’æŒãŸã›ã‚‹ãŸã‚å¤‰æ›é–¢æ•°ã‚ã‚Šã€‚
let selectedCPULevel = 3; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: æ™®é€š(3)
let chosenMode = 'memory';
let disableClicks = false;
let cpuWaitFlag = false;  // CPU waiting for modal to close

// å…¬é–‹æ™‚é–“ã‚’ 5ç§’ã«çµ±ä¸€ï¼ˆè¦ä»¶ï¼‰
const CARD_OPEN_TIME = 5000;

// CPU ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆ5æ®µéšï¼‰
// label/ delay(ms) / memory(0..1)
const cpuStrengthMap = {
  1: { label: "æœ€å¼±",  delay: 2600, memory: 0.0 },
  2: { label: "å¼±",    delay: 1800, memory: 0.25 },
  3: { label: "æ™®é€š",  delay: 1100, memory: 0.55 },
  4: { label: "å¼·",    delay: 650,  memory: 0.85 },
  5: { label: "æœ€å¼·",  delay: 300,  memory: 1.0 }
};

// äº’æ›: å¤ã„æ–‡å­—åˆ—è¨­å®š ('weak','normal','strong') ã‚’ãƒ¬ãƒ™ãƒ«ã«å¤‰æ›
function strengthStringToLevel(s){
  if(!s) return selectedCPULevel;
  s = String(s).toLowerCase();
  if(s === 'weak' || s === 'weakest') return 2;
  if(s === 'normal') return 3;
  if(s === 'strong') return 4;
  return selectedCPULevel;
}

// æ±ç”¨å–å¾—: å¼•æ•°ã«æ•°å€¤(1..5)ã‹æ–‡å­—åˆ—ã‚’å—ã‘å–ã‚Šã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿”ã™
function getCpuParams(strOrLevel){
  if(typeof strOrLevel === 'number'){
    return cpuStrengthMap[strOrLevel] || cpuStrengthMap[3];
  }
  // æ–‡å­—åˆ—ãªã‚‰å¤‰æ›ã—ã¦è¿”ã™
  const lvl = strengthStringToLevel(strOrLevel);
  return cpuStrengthMap[lvl];
}
function getCpuLabel(strOrLevel){
  return getCpuParams(strOrLevel).label;
}

// DOM refs
let turnTimer = null;
let babaHands = [];
let ownSelected = [];
let usedFunctionsSet = new Set();
let graphScale = 1;

const homeScreen = document.getElementById('homeScreen');
const gameContainer = document.getElementById('gameContainer');
const cardArea = document.getElementById('cardArea');
const learnedDiv = document.getElementById('learnedList');
const turnBadge = document.getElementById('turnBadge');
const setupModal = document.getElementById('setupModal');
const setupPlayersList = document.getElementById('setupPlayersList');
const graphModal = document.getElementById('graphModal');
const graphCanvas = document.getElementById('graphCanvas');
const graphCtx = graphCanvas ? graphCanvas.getContext('2d') : null;
const matchModal = document.getElementById('matchModal');
const matchContent = document.getElementById('matchContent');
const resultModal = document.getElementById('resultModal');
const resultScores = document.getElementById('resultScores');
const usedFunctionsList = document.getElementById('usedFunctionsList');

function randInt(n){ return Math.floor(Math.random()*n); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=randInt(i+1); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function formatEq(a,b){
  if(a===null) return 'JOKER';
  let aText=(a===1)?"x":(a===-1?"-x":`${a}x`);
  if(b===0) return `y=${aText}`;
  return `y=${aText}${b>0?"+":""}${b}`;
}
function formatNumber(v){ return Number.isInteger(v)?String(v):(Math.round(v*10)/10).toFixed(1); }
function makeTableHTML(a,b){
  const xValues=[-2, -1, 0, 1, 2];
  const yValues=xValues.map(x=>a*x+b);
  const xRow = xValues.map(x=>`<td>${x}</td>`).join('');
  const yRow = yValues.map(y=>`<td>${formatNumber(y)}</td>`).join('');
  return `
    <div class="table-card">
      <div class="title">å¯¾å¿œè¡¨</div>
      <table>
        <tr><th>x</th>${xRow}</tr>
        <tr><th>y</th>${yRow}</tr>
      </table>
    </div>
  `;
}

// ----- ãƒ›ãƒ¼ãƒ ç”»é¢ãƒ»ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–¢é€£ -----
function selectMode(m){
  chosenMode=m;
  const mEmb = document.getElementById('modeMemoryBtn');
  const mAbb = document.getElementById('modeBabaBtn');
  if(mEmb) mEmb.style.opacity=(m==='memory'?1:0.6);
  if(mAbb) mAbb.style.opacity=(m==='babanuki'?1:0.6);
}

// æ–°: ãƒ›ãƒ¼ãƒ ã®5æ®µãƒœã‚¿ãƒ³ã‚’æ“ä½œã™ã‚‹é–¢æ•°ï¼ˆãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ä»˜ãï¼‰
function setCPULevel(level){
  if(typeof level !== 'number') level = Number(level) || 3;
  selectedCPULevel = Math.max(1, Math.min(5, level));
  // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®æ›´æ–°ï¼ˆå­˜åœ¨ã™ã‚Œã°ï¼‰
  const btns = document.querySelectorAll('[data-level]');
  btns.forEach(b=>{
    b.style.boxShadow = (Number(b.dataset.level) === selectedCPULevel) ? '0 0 10px #ffd966' : 'none';
    b.style.opacity = (Number(b.dataset.level) === selectedCPULevel) ? '1' : '0.6';
  });
}

// äº’æ›ç”¨: æ—§API setCPU(levelString) ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã«å¯¾å¿œ
function setCPU(levelStr){
  // æ—§ãƒœã‚¿ãƒ³ãŒæ–‡å­—åˆ—ã‚’æ¸¡ã™å ´åˆã«å‘¼ã°ã‚Œã‚‹æƒ³å®šã‚’æ®‹ã™ï¼ˆäº’æ›ï¼‰
  if(typeof levelStr === 'string'){
    const map = { 'weak':2, 'normal':3, 'strong':4, 'weakest':1, 'strongest':5 };
    setCPULevel(map[levelStr] || 3);
  } else {
    setCPULevel(levelStr);
  }
}

function startGameFromHome(){
  const pairInput = document.getElementById('pairInput');
  const val=Number(pairInput?pairInput.value:4);
  if(isNaN(val)||val<3||val>10){ alert('ãƒšã‚¢æ•°ã¯3ã€œ10ã§å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  selectedPairs=val;
  mode=chosenMode;

  if(!playerConfig || playerConfig.length===0){
    // æ—¢å­˜ã®æŒ™å‹•ã«åˆã‚ã›ã€P2 ã‚’ CPU ã¨ã—ã¦è¿½åŠ ï¼ˆstrength ã¯ numeric ãƒ¬ãƒ™ãƒ«ã§å…¥ã‚Œã‚‹ï¼‰
    playerConfig=[
      {name:'P1', type:'human', strength:3},
      {name:'P2', type:'cpu', strength:selectedCPULevel}
    ];
  } else {
    // ã‚‚ã—æ—¢ã«ã‚ã‚‹å ´åˆã€ensure strength values are numeric levels for CPUs
    playerConfig = playerConfig.map(p=>{
      if(p.type === 'cpu') return {...p, strength: strengthStringToLevel(p.strength)};
      return p;
    });
  }

  players = playerConfig.length;
  usedFunctionsSet.clear();

  if(homeScreen) homeScreen.style.display='none';
  if(gameContainer) gameContainer.style.display='block';

  if(mode==='memory') startMemory(selectedPairs);
  else startBabanuki(selectedPairs);

  updateTurnDisplay();
}

function openSetup(){
  if(setupModal) setupModal.style.display='flex';
  const setupCount = document.getElementById('setupCount');
  if(setupCount) setupCount.value = players;
  renderSetupPlayers(players);
}
function closeSetup(){
  if(setupModal) setupModal.style.display='none';
}
function renderSetupPlayers(n){
  if(setupPlayersList) setupPlayersList.innerHTML='';
  for(let i=0;i<n;i++){
    const cfg = playerConfig[i] || {name:`P${i+1}`, type:'human', strength:3};
    const row = document.createElement('div');
    row.style.margin='6px';
    // strength select kept compatible with original values, but will be converted to numeric on applySetup
    row.innerHTML = `
      P${i+1} åç§°ï¼š <input id="name_p${i}" value="${cfg.name}" style="width:120px;">
      ã‚¿ã‚¤ãƒ—ï¼š <select id="type_p${i}">
        <option value="human">äººé–“</option>
        <option value="cpu">CPU</option>
      </select>
      <select id="strength_p${i}">
        <option value="2">å¼±</option>
        <option value="3">æ™®é€š</option>
        <option value="4">å¼·</option>
      </select>
    `;
    if(setupPlayersList) setupPlayersList.appendChild(row);
    setTimeout(()=>{
      const typeEl = document.getElementById(`type_p${i}`);
      const strengthEl = document.getElementById(`strength_p${i}`);
      if(typeEl) typeEl.value=cfg.type;
      // cfg.strength could be numeric or string; normalize
      const lvl = (typeof cfg.strength === 'number') ? cfg.strength : strengthStringToLevel(cfg.strength);
      if(strengthEl) strengthEl.value = Math.max(2, Math.min(4, lvl));
    },10);
  }
}
function applySetup(){
  const setupCount = document.getElementById('setupCount');
  const n = Number(setupCount?setupCount.value:players);
  players=n;
  playerConfig=[];
  for(let i=0;i<n;i++){
    const name=document.getElementById(`name_p${i}`)?.value||`P${i+1}`;
    const type=document.getElementById(`type_p${i}`)?.value;
    const strengthVal=document.getElementById(`strength_p${i}`)?.value;
    // strengthVal is numeric string (2..4), convert to number
    let strengthLevel = 3;
    if(strengthVal) strengthLevel = Number(strengthVal);
    playerConfig.push({name,type,strength: strengthLevel});
  }
  closeSetup();
  updateTurnDisplay();
}

// ----- ç¥çµŒè¡°å¼±ï¼ˆMEMORYï¼‰ -----
function startMemory(pairCount){
  deckCards=[]; firstFlip=null; scores=Array(players).fill(0); turnIndex=0; cpuMemory={}; disableClicks=false;
  const pool=[];
  for(let a=-4;a<=4;a++) for(let b=-3;b<=3;b++) if(a!==0) pool.push({a,b});
  const selected = shuffle(pool).slice(0,pairCount);
  deckCards=[];
  selected.forEach(s=>{
    const types=['formula','detail','graph','table'];
    const t1=types[randInt(types.length)];
    let t2=types[randInt(types.length)];
    while(t2===t1) t2=types[randInt(types.length)];
    deckCards.push({a:s.a,b:s.b,type:t1});
    deckCards.push({a:s.a,b:s.b,type:t2});
    usedFunctionsSet.add(`${s.a},${s.b}`);
  });
  shuffle(deckCards);
  remainingPairs = deckCards.length/2;
  renderMemoryTable();
  startTurnTimer();
  if(playerConfig[turnIndex] && playerConfig[turnIndex].type==='cpu') setTimeout(cpuPlayMemory,400);
}
function renderMemoryTable(){
  if(cardArea) cardArea.innerHTML='';
  const grid = document.createElement('div'); grid.className='card-grid';
  deckCards.forEach((c,idx)=>{
    const wrap=document.createElement('div'); wrap.className='card'; wrap.dataset.index=idx;
    const inner=document.createElement('div'); inner.className='card-inner';
    const front=document.createElement('div'); front.className='face front'; front.textContent='?';
    const back=document.createElement('div'); back.className='face back';
    if(c.type==='formula') back.innerHTML=`<div style="font-weight:800">${formatEq(c.a,c.b)}</div>`;
    else if(c.type==='detail') back.innerHTML=`a=${c.a}<br>b=${c.b}`;
    else if(c.type==='graph') { back.innerHTML=`<div style="font-weight:700">ğŸ“ˆ ã‚°ãƒ©ãƒ•</div>`; }
    else if(c.type==='table') back.innerHTML = makeTableHTML(c.a,c.b);
    inner.appendChild(front); inner.appendChild(back); wrap.appendChild(inner); grid.appendChild(wrap);

    wrap.addEventListener('click', ()=> {
      if(disableClicks) return;
      if(wrap.classList.contains('matched') || wrap.classList.contains('flipped')) return;

      if(c.type==='graph'){
        wrap.classList.add('flipped');
        showGraphLarge(c);
        // çµ±ä¸€: 5ç§’è¡¨ç¤ºï¼ˆCARD_OPEN_TIMEï¼‰
        setTimeout(() => {
            wrap.classList.remove('flipped');
            if(firstFlip !== null){
                const firstCardEl = document.querySelector(`.card[data-index='${firstFlip}']`);
                if(firstCardEl) firstCardEl.classList.remove('flipped');
                firstFlip = null;
                turnIndex = (turnIndex+1)%players;
                updateTurnDisplay();
                startTurnTimer();
                if(playerConfig[turnIndex] && playerConfig[turnIndex].type==='cpu') setTimeout(cpuPlayMemory,400);
            }
            disableClicks = false;
        }, CARD_OPEN_TIME);
        disableClicks = true;
      } else {
        onCardClickedMemory(idx);
      }
    });
  });
  if(cardArea) cardArea.appendChild(grid);
}

function onCardClickedMemory(idx){
  if(disableClicks) return;
  const card = document.querySelector(`.card[data-index='${idx}']`);
  if(!card) return;
  if(card.classList.contains('matched')||card.classList.contains('flipped')) return;
  revealCardMemory(idx);
}


function revealCardMemory(idx, fromCpu=false){
  if(disableClicks) return;
  const card = document.querySelector(`.card[data-index='${idx}']`);
  if(!card) return;
  if(card.classList.contains('matched')||card.classList.contains('flipped')) return;

  card.classList.add('flipped');
  const c = deckCards[idx];
  const key = `${c.a},${c.b}`;
  if(!cpuMemory[key]) cpuMemory[key] = new Set();
  cpuMemory[key].add(idx);

  if(firstFlip===null){ firstFlip=idx; return; }
  disableClicks=true;
  const first = deckCards[firstFlip], second = deckCards[idx];

  if(first.a===second.a && first.b===second.b){
    setTimeout(()=>{
      const c1=document.querySelector(`.card[data-index='${firstFlip}']`);
      const c2=document.querySelector(`.card[data-index='${idx}']`);
      if(c1) c1.classList.add('matched');
      if(c2) c2.classList.add('matched');
      cpuMemory[key]?.delete(firstFlip);
      cpuMemory[key]?.delete(idx);
      scores[turnIndex] = (scores[turnIndex]||0) + 1;
      remainingPairs--;
      addLearned(first);
      showMatchModal(first);
      firstFlip=null;
      disableClicks=false;
      if(remainingPairs<=0){
        endMemoryGame();
        return;
      }
      updateTurnDisplay();
      startTurnTimer();
      if(playerConfig[turnIndex] && playerConfig[turnIndex].type==='cpu') setTimeout(cpuPlayMemory,350);
    },400);
  } else {
    // çµ±ä¸€: 5ç§’è¡¨ç¤º
    setTimeout(()=>{
      const c1=document.querySelector(`.card[data-index='${firstFlip}']`);
      const c2=document.querySelector(`.card[data-index='${idx}']`);
      if(c1) c1.classList.remove('flipped');
      if(c2) c2.classList.remove('flipped');
      firstFlip=null;
      disableClicks=false;
      turnIndex = (turnIndex+1)%players;
      updateTurnDisplay();
      startTurnTimer();
      if(playerConfig[turnIndex] && playerConfig[turnIndex].type==='cpu') setTimeout(cpuPlayMemory,400);
    }, CARD_OPEN_TIME);
  }
}

function addLearned(card){
  const text = formatEq(card.a, card.b);
  const div = document.createElement('div');
  div.textContent=text;
  if(learnedDiv) learnedDiv.appendChild(div);
}

async function cpuPlayMemory(){
  const cpu = playerConfig[turnIndex];
  const param = getCpuParams(cpu.strength || selectedCPULevel);

  // CPU ãŒãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºä¸­ãªã‚‰é–‰ã˜ã‚‹ã¾ã§å¾…ã¤ï¼ˆè¦ä»¶ï¼‰
  if(cpuWaitFlag) await waitCpuStop();

  await new Promise(r=>setTimeout(r,param.delay));
  if(disableClicks) return;

  let pick1=null, pick2=null;
  const memChance = param.memory;

  if(Math.random() < memChance){
    for(const k of Object.keys(cpuMemory)){
      const arr = Array.from(cpuMemory[k]).filter(ix=>{
        const el=document.querySelector(`.card[data-index='${ix}']`);
        return el && !el.classList.contains('matched');
      });
      if(arr.length>=2){ pick1=arr[0]; pick2=arr[1]; break; }
    }
  }

  if(pick1===null){
    const available = Array.from(document.querySelectorAll('.card')).map((d,i)=>(!d.classList.contains('matched')&&!d.classList.contains('flipped'))?i:null).filter(x=>x!==null);
    if(available.length===0) return;
    pick1 = available[randInt(available.length)];
  }

  await cpuFlipMemory(pick1);
  await new Promise(r=>setTimeout(r,param.delay));

  if(!pick2){
    const available2 = Array.from(document.querySelectorAll('.card')).map((d,i)=>(!d.classList.contains('matched')&&!d.classList.contains('flipped') && i!==pick1)?i:null).filter(x=>x!==null);
    if(available2.length===0){
      turnIndex = (turnIndex+1)%players;
      updateTurnDisplay();
      startTurnTimer();
      if(playerConfig[turnIndex] && playerConfig[turnIndex].type==='cpu') setTimeout(cpuPlayMemory,400);
      return;
    }
    pick2 = available2[randInt(available2.length)];
  }

  await cpuFlipMemory(pick2);
}

async function cpuFlipMemory(idx){
  revealCardMemory(idx,true);
  const c = deckCards[idx];
  // CPU ãŒã‚ãã£ãŸã‚«ãƒ¼ãƒ‰ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤ºã€‚é–‰ã˜ã‚‹ã¾ã§CPUã¯åœæ­¢ã™ã‚‹ï¼ˆcpuWaitFlagï¼‰
  showCpuCard(c);
  await waitCpuStop();
}

// -- ãƒãƒæŠœã --
function startBabanuki(pairCount){
  deckCards=[]; scores=Array(players).fill(0); turnIndex=0; ownSelected=[]; disableClicks=false;
  const pool=[];
  for(let a=-4;a<=4;a++) for(let b=-3;b<=3;b++) if(a!==0) pool.push({a,b});
  const sel = shuffle(pool).slice(0,pairCount);
  let deck = [];
  sel.forEach(s=>{
    const types=['formula','detail','graph','table'];
    const t1=types[randInt(types.length)];
    let t2=types[randInt(types.length)];
    while(t2===t1) t2=types[randInt(types.length)];
    deck.push({a:s.a,b:s.b,type:t1});
    deck.push({a:s.a,b:s.b,type:t2});
    usedFunctionsSet.add(`${s.a},${s.b}`);
  });
  deck.push({a:null,b:null,text:'JOKER',type:'joker'});
  shuffle(deck);

  babaHands = Array.from({length:players},()=>[]);
  let i=0;
  while(deck.length) { babaHands[i%players].push(deck.pop()); i++; }
  babaHands.forEach(hand => {
    let discarded = true;
    while(discarded){
      discarded = false;
      const pair = findFirstPairInHand(hand);
      if(pair){
        const ids=[pair.i,pair.j].sort((a,b)=>b-a);
        ids.forEach(ix=>hand.splice(ix,1));
        discarded = true;
      }
    }
  });
  renderBabaUI();
  startTurnTimer();
  nextTurn();
}

function renderBabaUI(){
  if(cardArea) cardArea.innerHTML='';
  const container = document.createElement('div');
  container.className='baba-container';
  const circle = document.createElement('div');
  circle.className='circle-wrap';

  const cx = 280, cy = 210, radiusX = 220, radiusY = 140;

  for(let i=0;i<players;i++){
    const angle = (Math.PI*2)/players * i - Math.PI/2;
    const x = cx + radiusX * Math.cos(angle);
    const y = cy + radiusY * Math.sin(angle);
    const slot = document.createElement('div');
    slot.className=`player-slot ${i===turnIndex?'current':''}`;
    slot.style.left=`${x-60}px`;
    slot.style.top=`${y-25}px`;

    const panel = document.createElement('div');
    panel.className='slot-panel';
    panel.innerHTML=`
      <div style="font-weight:700;">${playerConfig[i].name}</div>
      <div class="small">æ‰‹æœ­: ${babaHands[i]?.length || 0}æš</div>
    `;
    slot.appendChild(panel);
    if(i === turnIndex && playerConfig[i].type==='human'){
      const handRow = document.createElement('div');
      handRow.className='hand-row';
      babaHands[i].forEach((c,hi)=>{
        const card = document.createElement('div');
        card.className=`hand-card ${c.type==='joker'?'joker':''} selectable ${ownSelected.some(s=>s.hi===hi)?'selected':''}`;
        card.textContent = c.text || formatEq(c.a,c.b);
        card.onclick=()=>onOwnCardClick(i,hi);
        handRow.appendChild(card);
      });
      panel.appendChild(handRow);
      const discardArea = document.createElement('div');
      discardArea.style.marginTop='10px';
      const discardBtn = document.createElement('button');
      discardBtn.textContent='é¸æŠã—ãŸ2æšã‚’æ¨ã¦ã‚‹';
      discardBtn.onclick=()=>confirmDiscard();
      discardArea.appendChild(discardBtn);
      panel.appendChild(discardArea);
    } else if(i !== turnIndex && playerConfig[turnIndex] && playerConfig[turnIndex].type==='human'){
      const drawBtn = document.createElement('button');
      drawBtn.className='draw-btn';
      drawBtn.textContent='ã“ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰å¼•ã';
      drawBtn.onclick=()=>humanDrawFrom(i);
      panel.appendChild(drawBtn);
    }
    circle.appendChild(slot);
  }

  container.appendChild(circle);
  if(cardArea) cardArea.appendChild(container);
  updateTurnDisplay();
}

function onOwnCardClick(pi,hi){
  if(pi !== turnIndex) return;
  if(!(playerConfig[pi] && playerConfig[pi].type==='human')) return;
  const hand = babaHands[pi];
  if(!hand || !hand[hi]) return;

  const foundIndex = ownSelected.findIndex(s=>s.hi===hi);
  if(foundIndex !== -1){
    ownSelected.splice(foundIndex, 1);
  } else {
    ownSelected.push({pi,hi});
    if(ownSelected.length>2) ownSelected.shift();
  }
  renderBabaUI();
}

function confirmDiscard(){
  if(ownSelected.length<2){
    alert('æ¨ã¦ã‚‹2æšã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  const aIdx = ownSelected[0].hi, bIdx = ownSelected[1].hi;
  const hand = babaHands[turnIndex];
  const c1 = hand[aIdx], c2 = hand[bIdx];

  if(!c1 || !c2){
    alert('é¸æŠãŒç„¡åŠ¹ã§ã™');
    ownSelected=[];
    renderBabaUI();
    return;
  }

  if(c1.a===c2.a && c1.b===c2.b && c1.a!==null){
    const ids = [aIdx,bIdx].sort((x,y)=>y-x);
    ids.forEach(ix=>hand.splice(ix,1));
    ownSelected=[];
    renderBabaUI();
    showMatchModal(c1);
    setTimeout(()=> nextTurn(), 500);
  } else {
    alert('é¸æŠã•ã‚ŒãŸ2æšã¯ãƒšã‚¢ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
    ownSelected=[];
    renderBabaUI();
  }
}

function humanDrawFrom(ti){
  if(ti===turnIndex||disableClicks) return;
  if(!babaHands[ti]||babaHands[ti].length===0) return;

  disableClicks = true;
  const pickIdx = randInt(babaHands[ti].length);
  const drawn = babaHands[ti].splice(pickIdx, 1)[0];
  babaHands[turnIndex].push(drawn);

  const infoCard = document.getElementById('infoCard');
  if(infoCard){
    infoCard.innerHTML=`
      <div class="card-inner" style="transform: rotateY(180deg);">
        <div class="face back" style="background:#0c2a3d; padding:16px;">
          <div style="font-weight:700;">${playerConfig[ti].name} ã‹ã‚‰å¼•ã„ãŸã‚«ãƒ¼ãƒ‰</div>
          <div style="margin-top:8px; font-size:18px;">${drawn.text || formatEq(drawn.a,drawn.b)}</div>
        </div>
      </div>
    `;
    infoCard.style.display='block';
  }

  // çµ±ä¸€: 5ç§’è¡¨ç¤ºï¼ˆCARD_OPEN_TIMEï¼‰
  setTimeout(()=>{
    if(infoCard) infoCard.style.display='none';
    const pair = findFirstPairInHand(babaHands[turnIndex]);
    if(pair){
      const ids=[pair.i,pair.j].sort((a,b)=>b-a);
      const c1 = babaHands[turnIndex][ids[0]];
      ids.forEach(ix=>babaHands[turnIndex].splice(ix,1));
      showMatchModal(c1);
    }
    disableClicks = false;
    nextTurn();
  }, CARD_OPEN_TIME);
}


async function cpuPlayBaba(){
  const cpu = playerConfig[turnIndex];
  const param = getCpuParams(cpu.strength || selectedCPULevel);

  // CPU ãŒãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºä¸­ãªã‚‰é–‰ã˜ã‚‹ã¾ã§å¾…ã¤ï¼ˆè¦ä»¶ï¼‰
  if(cpuWaitFlag) await waitCpuStop();

  await new Promise(r=>setTimeout(r,param.delay));
  const playersCount = players;
  let targetIdx = (turnIndex+1)%playersCount;
  let cnt=0;
  while((!babaHands[targetIdx] || babaHands[targetIdx].length===0) && cnt<playersCount){
    targetIdx = (targetIdx+1)%playersCount; cnt++;
  }
  if(!babaHands[targetIdx] || babaHands[targetIdx].length===0){
    nextTurn();
    return;
  }
  const pick = randInt(babaHands[targetIdx].length);
  const drawn = babaHands[targetIdx].splice(pick,1)[0];
  babaHands[turnIndex].push(drawn);

  renderBabaUI();

  showCpuCard(drawn);
  await waitCpuStop();

  const pair = findFirstPairInHand(babaHands[turnIndex]);
  if(pair){
    const ids=[pair.i,pair.j].sort((a,b)=>b-a);
    const c1=babaHands[turnIndex][ids[0]];
    ids.forEach(ix=>babaHands[turnIndex].splice(ix,1));
    showMatchModal(c1);
  }
  nextTurn();
}

// small utility: wait for cpuWaitFlag to clear
function waitCpuStop(){
  return new Promise(resolve=>{
    const timer = setInterval(()=>{
      if(!cpuWaitFlag){
        clearInterval(timer);
        resolve();
      }
    },100);
  });
}

function showCpuCard(card){
  cpuWaitFlag = true;
  const modal = document.getElementById('cpuCardModal');
  const cont = document.getElementById('cpuCardContent');
  if(cont) cont.innerHTML = card.text || formatEq(card.a, card.b);
  if(modal) modal.style.display='flex';
}
function closeCpuCardModal(){
  const modal = document.getElementById('cpuCardModal');
  if(modal) modal.style.display='none';
  // é–‰ã˜ãŸã‚‰ CPU å†é–‹
  cpuWaitFlag = false;
}

function findFirstPairInHand(h){
  for(let i=0;i<h.length;i++){
    for(let j=i+1;j<h.length;j++){
      if(h[i].a!==null && h[i].a===h[j].a && h[i].b===h[j].b) return {i,j,a:h[i].a,b:h[i].b};
    }
  }
  return null;
}

function endBabaGame(loser){
  stopTurnTimer();
  const winners = playerConfig.filter((p,i)=>p.name !== loser.name).map(p=>p.name);
  openResult(winners, 0, loser.name);
}
function nextTurn(){
  stopTurnTimer();
  const remainingPlayers = playerConfig.map((p,i)=>({hand:babaHands[i], length:babaHands[i]?.length || 0, index:i, name:p.name})).filter(p=>p.length > 0);
  if(remainingPlayers.length <= 1){
    if(remainingPlayers.length === 1 && remainingPlayers[0].hand.some(c=>c.type==='joker')){
      endBabaGame(remainingPlayers[0]);
      return;
    }
    if(remainingPlayers.length === 0){
      goHome();
      return;
    }
  }
  let nextIndex = (turnIndex + 1) % players;
  let count = 0;
  while((!babaHands[nextIndex] || babaHands[nextIndex].length === 0) && count < players){
    nextIndex = (nextIndex + 1) % players;
    count++;
  }
  if (count >= players) {
      goHome();
      return;
  }
  turnIndex = nextIndex;
  renderBabaUI();
  startTurnTimer();
  if(playerConfig[turnIndex] && playerConfig[turnIndex].type==='cpu'){
    cpuPlayBaba();
  }
}
function showGraphLarge(card){
  if(!graphModal || !graphCanvas) return;
  graphModal.style.display='flex';
  const title = document.getElementById('graphTitle');
  if(title) title.textContent = `ã‚°ãƒ©ãƒ•: ${formatEq(card.a, card.b)}`;
  graphScale = 1;
  drawGraph(card);
}
function drawGraph(card){
  if(!graphCtx) return;
  const w=graphCanvas.width, h=graphCanvas.height;
  const xCenter=w/2, yCenter=h/2;
  const UNIT_PX = 40 * graphScale;
  graphCtx.fillStyle='#fff';
  graphCtx.fillRect(0,0,w,h);
  graphCtx.save();
  graphCtx.translate(xCenter, yCenter);
  graphCtx.strokeStyle='#eee';
  graphCtx.lineWidth=1;
  const xMax = Math.ceil(w/2 / UNIT_PX);
  const yMax = Math.ceil(h/2 / UNIT_PX);
  for(let i=1; i<=xMax; i++){
    const px = i * UNIT_PX;
    graphCtx.beginPath();
    graphCtx.moveTo(px, -h/2);
    graphCtx.lineTo(px, h/2);
    graphCtx.stroke();
    graphCtx.beginPath();
    graphCtx.moveTo(-px, -h/2);
    graphCtx.lineTo(-px, h/2);
    graphCtx.stroke();
  }
  for(let i=1; i<=yMax; i++){
    const py = i * UNIT_PX;
    graphCtx.beginPath();
    graphCtx.moveTo(-w/2, py);
    graphCtx.lineTo(w/2, py);
    graphCtx.stroke();
    graphCtx.beginPath();
    graphCtx.moveTo(-w/2, -py);
    graphCtx.lineTo(w/2, -py);
    graphCtx.stroke();
  }
  graphCtx.strokeStyle='#222'; graphCtx.lineWidth=2.5;
  graphCtx.beginPath(); graphCtx.moveTo(-w/2,0); graphCtx.lineTo(w/2,0); graphCtx.stroke();
  graphCtx.beginPath(); graphCtx.moveTo(0,-h/2); graphCtx.lineTo(0,h/2); graphCtx.stroke();
  if(card.a){
    graphCtx.strokeStyle='#1976d2';
    graphCtx.lineWidth=3;
    graphCtx.beginPath();
    let started = false;
    for(let px=-w/2;px<w/2;px+=2){
      const gx = px/UNIT_PX;
      const gy = card.a*gx+card.b;
      const py = -gy*UNIT_PX;
      if(!started){
        graphCtx.moveTo(px, py);
        started = true;
      }else{
        graphCtx.lineTo(px, py);
      }
    }
    graphCtx.stroke();
  }
  graphCtx.restore();
}
function closeGraph(){
  if(graphModal) graphModal.style.display='none';
}
function zoomGraph(s){
  graphScale *= s;
  if(matchModal.style.display==='flex'){
    if(matchModal.graphCard){
      drawGraph(matchModal.graphCard);
    }
  }else if(graphModal.style.display==='flex'){
    const title = document.getElementById('graphTitle');
    if(title && graphModal.graphCard) drawGraph(graphModal.graphCard);
  }
}
function showMatchModal(card){
  if(!matchModal) return;
  matchModal.style.display='flex';
  matchModal.graphCard = card;
  document.getElementById('matchTitle').textContent = 'ãƒšã‚¢æˆç«‹: ' + formatEq(card.a, card.b);
  showMatchTab('formula');
}
function closeMatchModal(){
  if(matchModal) matchModal.style.display='none';
}
function showMatchTab(tab){
  if(!matchContent || !matchModal.graphCard) return;
  let c = matchModal.graphCard;
  if(tab==='formula'){
    matchContent.innerHTML = `<span style="font-weight:700;font-size:20px;">${formatEq(c.a, c.b)}</span>`;
  }else if(tab==='table'){
    matchContent.innerHTML = makeTableHTML(c.a, c.b);
  }else if(tab==='graph'){
    matchContent.innerHTML = '<canvas id="matchGraphCanvas" width="400" height="260" style="width:100%; height:220px; background:#fff; margin-top:10px;"></canvas>';
    const ctx = document.getElementById('matchGraphCanvas').getContext('2d');
    const w=400, h=260, cx=w/2, cy=h/2, UNIT=40;
    ctx.fillStyle='#fff';ctx.fillRect(0,0,w,h);
    ctx.save();ctx.translate(cx,cy);
    ctx.strokeStyle='#eee';ctx.lineWidth=1;
    for(let i=-4;i<=4;i++){
      ctx.beginPath();ctx.moveTo(i*UNIT,-h/2);ctx.lineTo(i*UNIT,h/2);ctx.stroke();
      ctx.beginPath();ctx.moveTo(-w/2,i*UNIT);ctx.lineTo(w/2,i*UNIT);ctx.stroke();
    }
    ctx.strokeStyle='#1976d2';ctx.lineWidth=3;ctx.beginPath();
    let started=false;
    for(let px= -w/2;px < w/2;px+=2){
      const gx=px/UNIT;const gy=c.a*gx+c.b;const py=-gy*UNIT;
      if(!started){ctx.moveTo(px,py);started=true;}
      else{ctx.lineTo(px,py);}
    }
    ctx.stroke();ctx.restore();
  }
}
function openResult(winList, pts, loser){
  if(!resultModal) return;
  resultModal.style.display='flex';
  if(resultScores){
    let txt = '';
    if(winList && loser){ txt = 'å‹è€…: '+winList.join('ãƒ»')+', æ•—è€…: '+loser; }
    else{
      txt = scores.map((s,i)=>`${playerConfig[i].name}: ${s}ç‚¹`).join('<br>');
    }
    resultScores.innerHTML = txt;
  }
  usedFunctionsList.innerHTML=[...usedFunctionsSet].map(str=>
    `<span style="display:inline-block;padding:4px 10px;margin:2px;background:#eee;color:#333;border-radius:8px;font-size:15px;">${formatEq(...str.split(',').map(Number))}</span>`
  ).join('');
}
function closeResult(){
  if(resultModal) resultModal.style.display='none';
}
function goHome(){
  if(gameContainer) gameContainer.style.display='none';
  if(homeScreen) homeScreen.style.display='flex';
  if(cardArea) cardArea.innerHTML='';
  if(learnedDiv) learnedDiv.innerHTML='';
}
function updateTurnDisplay(){
  if(!turnBadge) return;
  if(playerConfig && playerConfig[turnIndex]){
    const p = playerConfig[turnIndex];
    if(p.type === 'cpu'){
      // CPU ã®å¼·ã•ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ï¼ˆæ—¢å­˜ã®è¡¨ç¤ºã‚’å£Šã•ãªã„ï¼‰
      const label = getCpuLabel(p.strength);
      turnBadge.textContent = `${p.name}ï¼ˆ${label}ï¼‰`;
    } else {
      turnBadge.textContent = p.name;
    }
  }else{
    turnBadge.textContent = '';
  }
}
function startTurnTimer(){
  stopTurnTimer();
  turnTimer = setTimeout(()=>{},999999);
}
function stopTurnTimer(){
  if(turnTimer) clearTimeout(turnTimer);
  turnTimer = null;
}

// åˆæœŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆäº’æ›æ€§ç¢ºä¿ï¼‰
playerConfig = [ {name:'P1', type:'human', strength:3}, {name:'P2', type:'cpu', strength: selectedCPULevel} ];
// setCPULevelã§è¦‹ãŸç›®åˆæœŸåŒ–
setCPULevel(selectedCPULevel);

</script>
</body>
</html>
